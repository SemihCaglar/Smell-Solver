<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Repository Dashboard - {{ repo.repo_full_name }}</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- DataTables CSS from CDN -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
  <!-- Include Chart.js, date adapter, and zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    .header-actions {
      float: right;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h1>Repository Dashboard</h1>
    <!-- Settings Button -->
    <a href="{{ url_for('repo_routes.repo_settings', repo_id=repo.internal_id) }}" class="btn btn-secondary header-actions">
      Repository Settings
    </a>
  </div>
  
  <h3>{{ repo.repo_full_name }}</h3>
  
  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="stats-tab" data-toggle="tab" href="#stats" role="tab"
         aria-controls="stats" aria-selected="true">Statistics</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pr-tab" data-toggle="tab" href="#pr-list" role="tab"
         aria-controls="pr-list" aria-selected="false">Pull Requests</a>
    </li>
  </ul>
  
  <!-- Tab Content -->
  <div class="tab-content" id="dashboardTabsContent">
    <!-- Statistics Tab -->
    <div class="tab-pane fade show active" id="stats" role="tabpanel" aria-labelledby="stats-tab">
      <div class="mt-3">
        <div class="row">
          <!-- Statistics Cards -->
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-header">Total PRs Analyzed</div>
              <div class="card-body">
                <h2 class="card-title">{{ stats.total_prs }}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-header">Total Smells Detected</div>
              <div class="card-body">
                <h2 class="card-title">{{ stats.total_smells }}</h2>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-header">Most Common Smell</div>
              <div class="card-body">
                <h2 class="card-title">{{ stats.most_common_smell }}</h2>
              </div>
            </div>
          </div>
        </div>
        <!-- Charts Row -->
        <div class="row mt-4">
          <!-- Line Chart Column (Dynamic, Time-Based) -->
          <div class="col-md-6">
            <div class="chart-container">
              <canvas id="lineChart"></canvas>
            </div>
            <p class="text-center text-muted">Use mouse wheel or drag on the chart to zoom/pan the time range.</p>
          </div>
          <!-- Pie Chart Column (Static Dummy Data) -->
          <div class="col-md-6">
            <div class="chart-container">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Pull Requests Tab -->
    <div class="tab-pane fade" id="pr-list" role="tabpanel" aria-labelledby="pr-tab">
      <div class="mt-3">
        <table id="prTable" class="table table-striped table-bordered">
          <thead>
            <tr>
              <th>Date</th>
              <th>PR Number</th>
              <th>Title</th>
              <th>Smells Detected</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for pr in pr_list %}
            <tr>
              <td>{{ pr.date }}</td>
              <td>{{ pr.pr_number }}</td>
              <td>{{ pr.title }}</td>
              <td>{{ pr.smell_count }}</td>
              <td>
                <a href="{{ url_for('repo_routes.pr_analysis', repo_id=repo.internal_id, pr_number=pr.pr_number) }}" class="btn btn-primary btn-sm">
                  View Analysis
                </a>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center">No pull requests available.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Back to Main Dashboard -->
  <div class="mt-2">
    <a href="{{ url_for('main.main_page') }}" class="btn btn-outline-primary">Back to Dashboard</a>
  </div>
</div>

<!-- Include libraries: jQuery, DataTables, Bootstrap, Chart.js, Date Adapter, and Zoom Plugin -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
// Initialize DataTables for the PR list table
$(document).ready(function() {
    $('#prTable').DataTable({
        "order": [[ 0, "desc" ]],
        "columnDefs": [
            { "orderable": false, "targets": [2, 4] },
            { "searchable": false, "targets": [0,1,3,4] }
        ],
        "language": {
            "search": "Search in Title:"
        }
    });
});

// Dummy smell records with dates for demonstration purposes.
var smellRecords = [
  { date: "2025-03-20", smell_type: "Vague" },
  { date: "2025-03-19", smell_type: "Obvious" },
  { date: "2023-03-18", smell_type: "Misleading" },
  { date: "2025-03-20", smell_type: "Vague" },
  { date: "2025-03-20", smell_type: "Task" },
  { date: "2025-03-18", smell_type: "Obvious" },
  { date: "2025-03-17", smell_type: "Beautification" },
  { date: "2025-03-15", smell_type: "Obvious" },
  { date: "2025-03-20", smell_type: "Vague" },
  { date: "2025-03-19", smell_type: "Misleading" }
  // Add more records as needed...
];

// Allowed smell types (matches allowed_smells list)
var allowedSmells = ["Vague", "Misleading", "Obvious", "Beautification", "Commented-Out Code", "Attribution", "Too Much Information", "Non-Local", "No Comment", "Task"];

// Function to group and aggregate smell records by date and smell type.
// We keep date keys as ISO strings for Chart.js.
function aggregateSmellData(records) {
  var aggregation = {};
  records.forEach(function(record) {
    var dateStr = record.date;
    if (!aggregation[dateStr]) {
      aggregation[dateStr] = {};
      allowedSmells.forEach(function(type) {
        aggregation[dateStr][type] = 0;
      });
    }
    if (aggregation[dateStr].hasOwnProperty(record.smell_type)) {
      aggregation[dateStr][record.smell_type]++;
    }
  });
  return aggregation;
}

// Function to filter smellRecords based on selected smell types and aggregate by date.
function filterAndAggregateData() {
  // Get selected smell types from the checkboxes (if none, default to all)
  var selectedTypes = [];
  $('.smell-filter:checked').each(function() {
    selectedTypes.push($(this).val());
  });
  if(selectedTypes.length === 0){
    selectedTypes = allowedSmells.slice();
  }
  
  var filtered = smellRecords.filter(function(record) {
    return selectedTypes.indexOf(record.smell_type) !== -1;
  });
  
  var agg = aggregateSmellData(filtered);
  // Instead of converting to Date objects, use ISO strings (which Chart.js can parse).
  var dates = Object.keys(agg).sort();
  var datasets = [];
  // For each selected smell type, create a dataset for the line chart.
  selectedTypes.forEach(function(type) {
    var data = [];
    dates.forEach(function(dateStr) {
      data.push(agg[dateStr] ? agg[dateStr][type] || 0 : 0);
    });
    // For demonstration, assign a random color.
    var r = Math.floor(Math.random()*256);
    var g = Math.floor(Math.random()*256);
    var b = Math.floor(Math.random()*256);
    var backgroundColor = 'rgba(' + r + ',' + g + ',' + b + ',0.6)';
    var borderColor = 'rgba(' + r + ',' + g + ',' + b + ',1)';
    datasets.push({
      label: type,
      data: data,
      backgroundColor: backgroundColor,
      borderColor: borderColor,
      borderWidth: 2,
      fill: false
    });

  });
  
  console.log("Aggregated Data:", agg);
  console.log("Dates:", dates);
  console.log("Datasets:", datasets);

  return {
    labels: dates,
    datasets: datasets
  };
}

// Function to update the line chart with filtered data.
function updateLineChart() {
  var newData = filterAndAggregateData();
  lineChart.data.labels = newData.labels;
  lineChart.data.datasets = newData.datasets;
  lineChart.update();
}

// Create a global variable for the dynamic line chart with a time-based x-axis.
var lineCtx = document.getElementById('lineChart').getContext('2d');
var lineChart = new Chart(lineCtx, {
    type: 'line',
    data: filterAndAggregateData(), // Your aggregation function returns non-empty data
    options: {
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'day',
            tooltipFormat: 'yyyy-MM-dd'
          }
        },
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        zoom: {
          pan: {
            enabled: true,      // Enable panning
            mode: 'x',          // Allow panning only along the x-axis
            threshold: 10       // Optional: minimum distance in pixels to start panning
          },
          zoom: {
            wheel: {
              enabled: true    // Enable zooming with the mouse wheel
            },
            pinch: {
              enabled: true    // Enable pinch zooming on touch devices
            },
            mode: 'x'           // Allow zooming only along the x-axis
          },
          // Optional callback to see when zooming is complete
          onZoomComplete: function({chart}) {
            console.log("Zoom complete. New time range:", chart.scales.x.min, chart.scales.x.max);
          }
        }
      }
    }
});

// Initialize the pie chart (using dummy static data)
var pieCtx = document.getElementById('pieChart').getContext('2d');
var pieChart = new Chart(pieCtx, {
  type: 'pie',
  data: {
    labels: allowedSmells,
    datasets: [{
      label: "Smell Distribution",
      data: allowedSmells.map(() => Math.floor(Math.random() * 10) + 1),
      backgroundColor: allowedSmells.map(function() {
        var r = Math.floor(Math.random()*256);
        var g = Math.floor(Math.random()*256);
        var b = Math.floor(Math.random()*256);
        return 'rgba(' + r + ',' + g + ',' + b + ',0.6)';
      })
    }]
  }
});

// Bind filter button click to update the line chart.
$('#applyFilters').on('click', function() {
  updateLineChart();
});
</script>
</body>
</html>
